name: Screenshot Similarity Check

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID to download artifacts from (leave empty for latest)'
        required: false
        default: ''

jobs:
  check-similarity:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v5
        
      - name: "Get latest successful run ID"
        if: github.event.inputs.run_id == ''
        id: get-latest-run
        run: |
          # Install GitHub CLI
          sudo apt-get update && sudo apt-get install -y gh
          
          # Authenticate with GitHub CLI using the workflow token
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # Get the latest successful run ID of the main workflow
          LATEST_RUN_ID=$(gh run list --repo ${{ github.repository }} --workflow tests.yml --status completed --limit 1 --json databaseId --jq '.[0].databaseId')
          
          if [ -z "$LATEST_RUN_ID" ]; then
            echo "No successful runs found"
            exit 1
          fi
          
          echo "Latest successful run ID: $LATEST_RUN_ID"
          echo "run_id=$LATEST_RUN_ID" >> $GITHUB_OUTPUT
        shell: bash
        
      - name: "Set run ID"
        id: set-run-id
        run: |
          if [ -n "${{ github.event.inputs.run_id }}" ]; then
            echo "Using provided run ID: ${{ github.event.inputs.run_id }}"
            echo "run_id=${{ github.event.inputs.run_id }}" >> $GITHUB_OUTPUT
          else
            echo "Using latest run ID: ${{ steps.get-latest-run.outputs.run_id }}"
            echo "run_id=${{ steps.get-latest-run.outputs.run_id }}" >> $GITHUB_OUTPUT
          fi
        shell: bash
        
      - name: "Download Screenshots from Artifact"
        uses: dawidd6/action-download-artifact@v11
        with:
          workflow: tests.yml
          run_id: ${{ steps.set-run-id.outputs.run_id }}
          name: "Screenshots"
          path: "./tests/screenshots"
          
      - name: "Check Screenshot Similarity"
        run: |
          # Install ImageMagick for image comparison
          sudo apt-get update
          sudo apt-get install -y imagemagick bc
          
          # Debug: Show directory structure to verify paths
          echo "Current directory: $(pwd)"
          echo "Contents of ./images directory:"
          ls -la ./images || echo "images directory doesn't exist"
          echo "Contents of ./images/fixtures directory:"
          ls -la ./images/fixtures || echo "images/fixtures directory doesn't exist"
          echo "Contents of ./tests/screenshots directory:"
          ls -la ./tests/screenshots || echo "tests/screenshots directory doesn't exist"
          
          # Check if reference image exists
          if [ ! -f "./images/fixtures/ExitScreenshot.png" ]; then
            echo "Reference image ./images/fixtures/ExitScreenshot.png not found!"
            # Create the directory structure if it doesn't exist
            mkdir -p ./images/fixtures
            # Copy the screenshot as a new reference if available
            if [ -f "./tests/screenshots/ExitScreenshot.png" ]; then
              echo "Creating reference image from current screenshot"
              cp "./tests/screenshots/ExitScreenshot.png" "./images/fixtures/ExitScreenshot.png"
              echo "Reference image created. Skip comparison for this run."
              exit 0
            else
              echo "No screenshot available to create a reference image"
              exit 1
            fi
          fi
          
          # Check if test image exists
          if [ ! -f "./tests/screenshots/ExitScreenshot.png" ]; then
            echo "Test image ./tests/screenshots/ExitScreenshot.png not found!"
            exit 1
          fi
          
          # Compare images and get similarity score
          echo "Comparing screenshots..."
          SIMILARITY=$(compare -metric RMSE "./images/fixtures/ExitScreenshot.png" "./tests/screenshots/ExitScreenshot.png" null: 2>&1) || true
          
          echo "Similarity output: $SIMILARITY"
          
          # Extract the numeric value from the similarity output
          # The output typically looks like: "467.579 (0.0071348)" where 0.0071348 is the normalized value
          # We want to extract that normalized value
          NORMALIZED_VALUE=$(echo $SIMILARITY | grep -oE '\([0-9]+(\.[0-9]+)?\)' | tr -d '()')
          
          if [ -z "$NORMALIZED_VALUE" ]; then
            echo "Failed to extract normalized value from similarity output"
            # Fall back to the first numeric value if normalized value not found
            VALUE=$(echo $SIMILARITY | grep -oE '[0-9]+(\.[0-9]+)?' | head -1)
            if [ -z "$VALUE" ]; then
              echo "Failed to extract any numeric value from similarity output"
              exit 1
            fi
            echo "Using first numeric value: $VALUE"
          else
            VALUE=$NORMALIZED_VALUE
            echo "Using normalized value: $VALUE"
          fi
          
          # Install bc for floating point comparison
          sudo apt-get install -y bc
          
          # Fail if difference is too large
          # Adjusted threshold to 0.01 (1%) since the normalized value is between 0-1
          THRESHOLD=0.01
          echo "Difference value: $VALUE (threshold: $THRESHOLD)"
          
          if (( $(echo "$VALUE > $THRESHOLD" | bc -l) )); then
            echo "Screenshots differ significantly!"
            exit 1
          else
            echo "Screenshots are similar enough."
          fi
        shell: bash
        
      # - name: "Create Issue if Check Fails"
      #   if: failure()
      #   run: |
      #     # Install GitHub CLI if not already installed
      #     command -v gh >/dev/null 2>&1 || {
      #       sudo apt-get update && sudo apt-get install -y gh
      #       echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
      #     }
      #     
      #     # Create an issue
      #     gh issue create \
      #       --title "Screenshot Similarity Check Failed" \
      #       --body "The screenshot similarity check failed for run ID ${{ steps.set-run-id.outputs.run_id }}. Please check the workflow run for more details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
      #       --label "bug"
      #   shell: bash
